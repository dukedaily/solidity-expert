# ä¸€ã€æ¦‚è¿°

## 1. æœ¬æ•™ç¨‹ä»‹ç»

1. ä½¿ç”¨hardhatéƒ¨ç½²åˆ°ä¸åŒç½‘ç»œï¼Œè‡ªåŠ¨verifyä»£ç 
2. å•å…ƒæµ‹è¯•ç¼–å†™
3. deployè„šæœ¬ï¼Œdeployæ’ä»¶ä½¿ç”¨
4. å¯å‡çº§åˆçº¦ç¼–å†™ï¼Œä½¿ç”¨ï¼Œé¡µé¢å…³è”

ä½ å¯¹å·¥å…·é“¾çš„æ‰€æœ‰ç–‘é—®éƒ½ä¼šåœ¨è¿™é‡Œå¾—åˆ°demoç­”æ¡ˆï¼



## 2. hardhatæ¡†æ¶çš„å¥½å¤„

1. åœ¨configæ–‡ä»¶ä¸­é…ç½®ç½‘ç»œï¼Œéƒ¨ç½²åœ¨nodeï¼Œhardhatï¼Œå…¶ä»–æŒ‡å®šçš„ç½‘ç»œ
2. åœ¨.envä¸­å†™ç§˜é’¥ç­‰ä¿¡æ¯
3. å¯ä»¥è‡ªåŠ¨éƒ¨ç½²ï¼ŒVerifyä»£ç 
4. å¯ä»¥ç¼–å†™å•å…ƒæµ‹è¯•

# äºŒã€ä»£ç ç›®å½•

å‚è€ƒé“¾æ¥ï¼š

1. æ•™ç¨‹ï¼šhttps://medium.com/@rahulsethuram/the-new-solidity-dev-stack-buidler-ethers-waffle-typescript-tutorial-f07917de48ae
2. hardhatï¼šhttps://learnblockchain.cn/docs/hardhat/guides/waffle-testing.html

# ä¸‰ã€éƒ¨ç½²åœ¨localhost

å®‰è£…ï¼š

```sh
npm install
```

ç¼–è¯‘ï¼š

```sh
npm run compile
```

å•å…ƒæµ‹è¯•ï¼š

```sh
npm run test
```

å¯åŠ¨æœ¬åœ°å†…å­˜åŒºå—é“¾ç¯å¢ƒï¼š

```sh
npx hardhat node 
```

## 1. æ™®é€šéƒ¨ç½²
æ–¹å¼1ï¼Œä½¿ç”¨hardhat-deployåŒ…éƒ¨ç½²ï¼Œå…·ä½“ç¼–å†™æŸ¥çœ‹`deploy`æ–‡ä»¶å¤¹

```js
npx hardhat --network localhost deploy
```

æ–¹å¼2ï¼Œä½¿ç”¨è„šæœ¬éƒ¨ç½²

```js
npx hardhat run --network localhost scripts/deploy.ts
```

æµ‹è¯•ä¸€ä¸‹ï¼Œéœ€è¦ä¿®æ”¹åœ°å€`testV1.ts`ä¸­çš„åœ°å€ä¸ºåˆšåˆšéƒ¨ç½²çš„åœ°å€ã€‚

```js
npx hardhat run scripts/testV1.ts --network localhost
```

## 2. å¯å‡çº§éƒ¨ç½²

### - ä»¥å¯å‡çº§æ–¹å¼éƒ¨ç½²åˆçº¦

1. æ‰§è¡Œå‘½ä»¤ï¼š

  ```sh
  npx hardhat run --network localhost scripts/01-deploy_counter.ts
  ```

  > å¾—åˆ°åœ°å€ï¼š0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9

### - è°ƒç”¨åæŸ¥çœ‹è¿è¡Œç»“æœ

1. ä¿®æ”¹testV1.tsä¸­çš„åœ°å€ä¸º: `0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9`

2. æ‰§è¡Œå‘½ä»¤ï¼š

   ```js
   npx hardhat run --network localhost scripts/testV1.ts
   ```

### - ä¿®æ”¹ä»£ç åå¼€å§‹å‡çº§

1. é¦–å…ˆåˆ›å»ºæ–°æ–‡ä»¶ï¼šCounterV2Upgrade.solï¼Œç›¸æ¯”ä¹‹ä¸‹æ¯”ä¹‹å‰çš„åˆçº¦å¢åŠ äº†`changeOwner`æ–¹æ³•ã€‚

2. ä¿®æ”¹`02-upgradeCounterV2.t`ä¸­çš„åˆçº¦åœ°å€ä¸ºï¼š`0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9`ã€‚

3. æ‰§è¡Œå‡çº§å‘½ä»¤ï¼š

   ```sh
   npx hardhat run --network localhost scripts/02-upgradeCounterV2.ts
   ```

### - è°ƒç”¨åˆçº¦ï¼Œç¡®è®¤ç»“æœ

1. ä¿®æ”¹`testV2.ts`ä¸­çš„åœ°å€ä¸ºï¼š`0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9`

2. æ‰§è¡Œå‘½ä»¤ï¼ŒæŸ¥çœ‹ç»“æœï¼Œç»“æœåº”è¯¥`åŠ 1`ï¼Œ`manager`ä¹Ÿåº”è¯¥å‘ç”Ÿæ”¹å˜ã€‚

   ```sh
   npx hardhat run --network localhost scripts/testV2.ts
   ```

# å››ã€éƒ¨ç½²åœ¨kovan

é¦–å…ˆéœ€è¦ä¿®æ”¹.env.bakæ–‡ä»¶ï¼Œä¿®æ”¹ä¸º.envï¼Œå¹¶ä¸”å¡«å…¥è‡ªå·±çš„API_KEYä¿¡æ¯ï¼š(è‡ªè¡Œæœç´¢ğŸ”)

```js
MNEMONIC="ä½ çš„åŠ©è®°è¯"

#DEBUG=true
PRIVATE_KEY="ä½ æŒ‡å®šçš„ä¸€ä¸ªç§é’¥"
INFURA_API_KEY="ä½ çš„Infuraç§é’¥"

# Optional Etherscan key, for automatize the verification of the contracts at Etherscan
ETHERSCAN_API_KEY="ä½ çš„ETHERSCAN_API_KEY"
```



## 1. æ™®é€šéƒ¨ç½²ï¼ˆç•¥ï¼‰

ç•¥ï¼ŒåŒä¸Šï¼Œåªéœ€è¦å°†localhostæ”¹ä¸ºkovanå³å¯ã€‚

```sh
#éƒ¨ç½²åœ¨æœ¬åœ°ï¼š
npx hardhat --network localhost deploy

#éƒ¨ç½²åœ¨kovanï¼š
npx hardhat --network kovan deploy
```



## 2. å¯å‡çº§éƒ¨ç½²

> å…ˆå¤‡ä»½.openzeppelinä¸‹é¢çš„kovan.jsonæ–‡ä»¶ï¼ˆè‹¥æœ‰ï¼‰

### - ä»¥å¯å‡çº§æ–¹å¼éƒ¨ç½²åˆçº¦

1. æ‰§è¡Œå‘½ä»¤ï¼š

   ```sh
   npx hardhat run --network kovan scripts/01-deploy_counter.ts
   ```

2. è¯¥æ“ä½œä¼šéƒ¨ç½²ä¸‰ä¸ªåˆçº¦ï¼Œå¾—åˆ°ä¸‰ä¸ªåœ°å€ï¼ˆå­˜åœ¨vscodeå·¥ç¨‹ä¸‹ï¼š.openzeppelin/kovan.jsonæ–‡ä»¶ä¸­ï¼‰

   1. **proxyåˆçº¦ï¼ˆ==å¯¹å¤–ä¸å˜çš„==ï¼‰ï¼š**
      1. åœ°å€ï¼š0xF5deCF1CB99C4D6Aa22Ee49A3D32Eb21bee73d22ã€‚
      2. é»˜è®¤verifyï¼Œå› ä¸ºè¿™ä¸ªå‡çº§åˆçº¦æ˜¯openzeppelinå®˜æ–¹æä¾›çš„ï¼Œå¾ˆå¤šäººå·²ç»éªŒè¯è¿‡äº†ã€‚
   2. **proxyAdmainåˆçº¦ï¼š**
      1. åœ°å€ï¼š0x5670ffB7167bc72d3B11e209133aCC73Fb9292beã€‚
      2. é»˜è®¤verifyï¼Œproxyçš„ç®¡ç†åˆçº¦ï¼Œç”¨äºä¿®æ”¹ä»£ç†ä¸å®ç°å‡çº§æ“ä½œã€‚
   3. **æˆ‘ä»¬çš„Counteråˆçº¦ï¼š**
      1. åœ°å€ï¼š0x06e166edB942fe7Dd2b04d13443BbB6e835aEd39ã€‚
      2. æˆ‘ä»¬çœŸæ­£å…³å¿ƒçš„ä¸šåŠ¡é€»è¾‘ã€‚
   

### - è°ƒç”¨åæŸ¥çœ‹è¿è¡Œç»“æœ

1. ä¿®æ”¹`testV1.ts`ä¸­çš„åœ°å€ä¸º: `0xF5deCF1CB99C4D6Aa22Ee49A3D32Eb21bee73d22`ã€‚

2. æ‰§è¡Œå‘½ä»¤ï¼š

   ```js
   npx hardhat run --network kovan scripts/testV1.ts
   ```

3. é€šè¿‡æµè§ˆå™¨ï¼Œè¾“å…¥ä»£ç†åˆçº¦Proxyåœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å·²ç»æˆåŠŸè°ƒç”¨äº†ä¸€æ¬¡CountUpï¼Œæ•°æ®å˜æˆï¼š1ï¼Œ å¹¶ä¸”é€šè¿‡Internal Txnsæ ‡ç­¾çœ‹åˆ°äº¤äº’çš„åˆçº¦æ˜¯å…·ä½“å®ç°åˆçº¦ï¼š

   ![image-20211105102513240](assets/image-20211105102513240.png)

   å…·ä½“äº¤äº’åˆçº¦æ­£æ˜¯æˆ‘ä»¬çš„Counteråˆçº¦ï¼Œå¦‚ä¸‹å›¾ï¼š

   ![image-20211105102538738](assets/image-20211105102538738.png)

   ç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸Šé¢è¿˜æœ‰ä¸ªï¼š0x0000äº¤äº’ï¼Ÿç»†èŠ‚éœ€è¦çœ‹ä»£ç ã€‚

4. æŸ¥çœ‹`proxyAdmin`åˆçº¦ï¼Œæ£€æŸ¥ä¸€ä¸‹æ•°æ®ï¼Œåœ¨è¯»æ–¹æ³•ä¸­ï¼Œå¦‚ä¸‹å›¾ï¼šè¾“å…¥proxyåœ°å€ï¼Œå¯ä»¥å¾—åˆ°æˆ‘ä»¬çš„Counteråˆçº¦åœ°å€ï¼š

   ![image-20211105103020934](assets/image-20211105103020934.png)

   åœ¨å†™æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°proxyAdmainçš„ç›¸å…³æ–¹æ³•ï¼šæ›´æ¢ç®¡ç†å‘˜ï¼Œæ›´æ¢å®ç°åˆçº¦

   ![image-20211105103208502](assets/image-20211105103208502.png)

   4. æ¥ä¸‹æ¥æˆ‘ä»¬verifyæˆ‘ä»¬çš„Counteråˆçº¦ä»£ç ï¼š

   ```sh
   #npx hardhat verify --network kovan <åˆçº¦åœ°å€> constructorå‚æ•°
   npx hardhat verify --network kovan 0x06e166edB942fe7Dd2b04d13443BbB6e835aEd39
   ```

   ![image-20211105104228647](assets/image-20211105104228647.png)

   5. ä¸ºäº†åœ¨proxyä¸‹å¯ä»¥ç›´æ¥æ“ä½œå…·ä½“çš„å®ç°é€»è¾‘ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å…³è”proxyå’Œimplementationçš„å…³ç³»ï¼Œæ“ä½œä¸ºï¼šåœ¨proxyé¡µé¢ç‚¹å‡»ï¼šmore option -> is this a proxy?

   ![image-20211105104327033](assets/image-20211105104327033.png)

   ç‚¹å‡»ï¼šverify

   ![image-20211105104422997](assets/image-20211105104422997.png)

   ç‚¹å‡»ï¼šsave

   ![image-20211105104438472](assets/image-20211105104438472.png)

   æ­¤æ—¶ï¼Œå›åˆ°proxyé¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°implementationå¯¹åº”çš„æ–¹æ³•

   ![image-20211105104520515](assets/image-20211105104520515.png)

   ![image-20211105104554392](assets/image-20211105104554392.png)

   ç‚¹å‡»ï¼šcountUpåï¼Œæ•°æ®å˜æˆï¼š2

   ![image-20211105104708548](assets/image-20211105104708548.png)

### - ä¿®æ”¹ä»£ç åå¼€å§‹å‡çº§

1. ä¿®æ”¹ï¼šï¼ˆproxyåœ°å€ï¼‰

   ```sh
   02-upgradeCounterV2.tsä¸­çš„åœ°å€ä¸ºï¼š0xF5deCF1CB99C4D6Aa22Ee49A3D32Eb21bee73d22
   ```

2. æ‰§è¡Œï¼š

   ```sh
   npx hardhat run --network kovan scripts/02-upgradeCounterV2.ts
   ```

   åœ¨upgradeCounterV2åˆçº¦ä¸­ï¼Œæˆ‘ä»¬å¢åŠ äº†ä¸€ä¸ª`changeOwner`æ–¹æ³•ï¼Œå…¶ä»–å†…å®¹æœªæ”¹å˜ã€‚

   ```js
       function changeOwner(address owner) public {
           require(msg.sender == manager, "forbidden!"); 
           manager = owner;
       }
   ```

   å‡çº§æˆåŠŸï¼š

   ![image-20211105105010525](assets/image-20211105105010525.png)

3. åˆ°adminProxyä¸­æ£€æŸ¥å‡çº§åçš„implementationåœ°å€ï¼š [0xC564f82cA3109F701420a212c345C4747Bc16b0f](https://kovan.etherscan.io/address/0xC564f82cA3109F701420a212c345C4747Bc16b0f)

   ![image-20211105105154465](assets/image-20211105105154465.png)

4. å›åˆ°proxyä¸­ï¼ŒæŸ¥çœ‹å†…éƒ¨äº¤æ˜“ï¼Œå‘ç°ï¼š

   ![image-20211105105413746](assets/image-20211105105413746.png)

5. å¯¹æ–°å‘å¸ƒçš„implementationåˆçº¦è¿›è¡Œverifyä»£ç ï¼š

   ```js
   npx hardhat verify --network kovan 0xC564f82cA3109F701420a212c345C4747Bc16b0f
   ```

   ![image-20211105105930918](assets/image-20211105105930918.png)

6. æŸ¥çœ‹proxyçš„å†™æ–¹æ³•ï¼Œæˆ‘ä»¬çš„æ–°æ–¹æ³•ä¸­ï¼Œçœ‹åˆ°æ–°æ–¹æ³•å·²ç»å­˜åœ¨ï¼š

   ![image-20211105110041907](assets/image-20211105110041907.png)

   è¯»æ–¹æ³•ä¸­ï¼ŒgetCountä¾ç„¶ä¸ºå‡çº§ä¹‹å‰çš„å€¼ï¼š2

   ![image-20211105110110236](assets/image-20211105110110236.png)

### - è°ƒç”¨åˆçº¦ï¼Œç¡®è®¤ç»“æœ

1. ä¿®æ”¹`testV2.ts`ä¸­çš„åœ°å€ä¸ºï¼š0xF5deCF1CB99C4D6Aa22Ee49A3D32Eb21bee73d22

2. æ‰§è¡Œå‘½ä»¤

   ```sh
   npx hardhat run --network kovan scripts/testV2.ts
   ```

3. æ•ˆæœ

   ![image-20211105110641875](assets/image-20211105110641875.png)

   æ•°å€¼æ”¹å˜ï¼Œowneræ”¹å˜ï¼š

   ![image-20211105110709232](assets/image-20211105110709232.png)



## å…¶ä»–çç¢é—®é¢˜ï¼š

1. éœ€è¦å®‰è£…ï¼š

```js
npm i --save-dev @types/chai-as-promised
npm install --save-dev solidity-coverage  #ä¸ºäº†è¿è¡Œcoverage
```

2. ä»€ä¹ˆæ˜¯è¦†ç›–æµ‹è¯•ï¼Ÿè¿™ä¸ªä½¿ç”¨solidity-coverageæä¾›çš„åŠŸèƒ½

3. hreä¸hardhatçš„å…³ç³»ï¼Œè¿™å›ç»ˆäºå¼„æ¸…æ¥šäº†ã€‚

```sh
#hardhatè¿™ä¸ªåŒ…exportçš„æ˜¯envï¼Œè¿™ä¸ªenvå°±æ˜¯ï¼šHardhatRuntimeEnvironment
import hre from 'hardhat'  

#è¿™å¥çš„æ„æ€æ˜¯ä»envä¸­è§£æå‡ºethersï¼Œå› ä¸ºHardhatRuntimeEnvironmentæ˜¯åŒ…å«ethersçš„
import { ethers} from "hardhat"; 
ä¸Šé¢è¿™å¥ç­‰ä»·äºä»hreå¯¹è±¡è§£æå‡ºäº†ï¼šethers
å³hreä¸­åŒ…å«ethers
	#hre.ethers
	#{ ethers} = hre

#æƒ³å¯¼å…¥åŸç”Ÿçš„etherséœ€è¦æŒ‡å®šä¸º
import ethers_raw from "ethers"

#hre.ethersåŒ…é‡Œé¢å®ç°äº†åŸç”ŸåŒ…çš„æ‰€æœ‰åŠŸèƒ½ï¼Œå¹¶ä¸”åšäº†å¢å¼º
```

4. chaiå’Œhardhat-waffleçš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ



## deploy

https://learnblockchain.cn/article/2354

```js
npm install -D hardhat-deploy
```



## å‡çº§

ç¿»è¯‘ï¼šhttps://learnblockchain.cn/article/1990

åŸæ–‡ï¼šhttps://docs.openzeppelin.com/learn/upgrading-smart-contracts

```js
npm install --save-dev @openzeppelin/hardhat-upgrades

npm i @openzeppelin/contracts
```

